---
title: "Rmaincode"
output: html_document
date: "2023-12-18"
---

```{r}

#Library
library(dplyr)
rm(list = ls())
cat("\014")  # Clears the console



library(dplyr)
library(ggplot2)
library(mediation)
library(car)


```


```{r}
#Read the data

ECfinal<- read.csv("C:/Users/sara ghasem pour/GitLab/Path2/Thesis/DataCleaning/ECfinal.csv")

```

SNAP
```{r}
# Create a new binary column 'SNAP_Selected' based on the presence of "SNAP" in 'CNP4'
ECfinal$SNAP <- ifelse(grepl("SNAP", ECfinal$CNP4, fixed = TRUE), 1, 0)


```


Picky eating- Parent control- Parent emotional

```{r}
# Define the mapping from text responses to numeric values
EClist <- c("Always" = 5, "Often" = 4, "Sometimes" =3 , "Rarely" = 2, "Never" = 1 )

# List the question columns for each category based on the names you provided
control_questions <- c("PFSQ5", "PFSQ17", "PFSQ18", "PFSQ20", "PFSQ24", "PFSQ26")
emotional_questions <- c("PFSQ25", "PFSQ21", "PFSQ22", "PFSQ15", "PFSQ13", "PFSQ2")
picky_questions <- c("CEBQ32", "CEBQ24", "CEBQ16", "CEBQ10", "CEBQ7")

# Convert text responses to numeric values and calculate mean scores for control, emotional eating, and picky eating
ECfinal <- ECfinal %>%
  mutate(
    across(all_of(control_questions), ~ as.numeric(EClist[.x]), .names = "numeric_{.col}"),
    across(all_of(emotional_questions), ~ as.numeric(EClist[.x]), .names = "numeric_{.col}"),
    across(all_of(picky_questions), ~ as.numeric(EClist[.x]), .names = "numeric_{.col}")
  ) %>%
  rowwise() %>%
  mutate(
    Control_Score = mean(c_across(starts_with("numeric_PFSQ")), na.rm = TRUE),
    Emotional_Score = mean(c_across(starts_with("numeric_PFSQ")), na.rm = TRUE),
    Picky_Score = mean(c_across(starts_with("numeric_CEBQ")), na.rm = TRUE)
  ) %>%
  ungroup()


```

Checked the normality  


 picky _Score has  not normal distributed, I did :
 Log Transformation
 Square Root Transformation
 Inverse Transformation
 Box-Cox Transformation
 Yeo-Johnson Transformation

 
 
 
```{r}
#shapiro test normality for main variables
variables_to_test <- c("Picky_Score", "Control_Score", "Emotional_Score")
print(variables_to_test)
# Apply the Shapiro-Wilk test to each variable
normality_tests <- lapply(ECfinal[variables_to_test], shapiro.test)
# Print the results
print(normality_tests)


#QQplot

variables_to_test <- c("Picky_Score", "Control_Score", "Emotional_Score")

for (variable in variables_to_test) {
  # Create a QQ plot for each variable
  p <- ggplot(ECfinal, aes(sample = .data[[variable]])) +
       stat_qq() +
       stat_qq_line(colour = "blue") +
       ggtitle(paste("QQ Plot for", variable)) +
       theme_minimal()
  
  # Print the plot
  print(p)
}



# Log transformation 

ECfinal$Picky_Score_log <- log(ECfinal$Picky_Score + 1e-6)
ECfinal$Control_Score_log <- log(ECfinal$Control_Score + 1e-6)
ECfinal$Emotional_Score_log <- log(ECfinal$Emotional_Score + 1e-6)


#QQplot log

variables_log <- c("Picky_Score_log", "Control_Score_log", "Emotional_Score_log")

for (variable in variables_log) {
  # Create a QQ plot for each variable
  p <- ggplot(ECfinal, aes(sample = .data[[variable]])) +
       stat_qq() +
       stat_qq_line(colour = "blue") +
       ggtitle(paste("QQ Plot for", variable)) +
       theme_minimal()
  
}
# Shapiro-Wilk test for log-transformed variables
shapiro_results_log <- lapply(ECfinal[variables_log], shapiro.test)

# Print the Shapiro-Wilk test results
print(shapiro_results_log)



```



Household
```{r}

ECfinal$household <- as.numeric(as.character(ECfinal$household))

```

childs number
```{r}

ECfinal$num_children <- as.numeric(as.character(ECfinal$num_children))

```



Relationship
```{r}
relationship_map <- c("Never married" = 5, 
                      "Married" = 1, 
                      "Divorced" = 2, 
                      "Separated" = 3, 
                      "Widowed" = 4)

# Convert text responses to numeric values for Relationship status
ECfinal <- ECfinal %>%
  mutate(Relationship = relationship_map[relationship])

```




RaceEthnicity
```{r}
# Create a data frame with the race data
race_data <- data.frame(
  race_category = c("White", "Vietnamese", "Other Asian", "Native Hawaiian", 
                    "Japanese", "Chinese", "Black or African American", 
                    "Asian Indian", "Another race", 
                    "American Indian or Alaska Native", "Indonesian", "Bengali", "Asian"),
  value = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3),
  detailed_description = c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "Indonesian", "Bengali", "Asian")
)
# Convert race_category to a factor with levels ordered by the value column
race_data$race_numeric <- as.numeric(factor(race_data$race_category, 
                                            levels = unique(race_data$race_category[order(race_data$value)])))


```


ParentEducation
```{r}
# Define the mapping from education levels to numeric values
education_map <- c("Some high school" = 1, 
                   "High school degree or GED" = 2, 
                   "Some college or associates degree" = 3, 
                   "4 years college degree" = 4, 
                   "Advanced degree" = 5)

# Convert text responses to numeric values for Education
ECfinal <- ECfinal %>%
  mutate(Education = education_map[ed])

```

HouseholdIncome
```{r}
income_map <- c("Less than $20,000" = 1, 
                "$20,000 - $39,999" = 2, 
                "$40,000 - $49,999" = 3, 
                "$50,000 - $74,999" = 4, 
                "$75,000 - $99,999" = 5, 
                "More than $100,000" = 6)
#Convert text responses to numeric values and calculate mean scores for Income
ECfinal <- ECfinal %>%
  mutate(Income = income_map[income])

```

Parent
```{r}

# Define the mapping from childs_ parents relationship levels to numeric values
relation_map <- c("Father" = 1, "Mother" = 2, "Other" = 3)

# Assuming 'com2' is your data frame and 'relation' is the column with these responses
ECfinal <- ECfinal %>%
  mutate(Relation = relation_map[parent])




```

Child_sex
```{r}


# Define the mapping from sex categories to numeric values (only male and female)
sex_map <- c("Male" = 1, "Female" = 2)

# Assuming 'com2' is your data frame and 'sex' is the column with these responses
ECfinal <- ECfinal %>%
  mutate(Sex = sex_map[sex])


```

Mediation

Model 1 and multicllinearity test
```{r}

# Mediation analysis with interactions
mediator_model <- glm(SNAP ~ Control_Score_log + Sex + Relationship+
                        Income + Education + Relation + household + num_children,
                      family = binomial, data = ECfinal)

# Step 2: Outcome Model
outcome_model <- lm(Picky_Score_log ~ Control_Score_log + SNAP +
                      Sex + Income + Education + Relation + household + Relationship + num_children , data = ECfinal)

# Step 3: Perform Mediation Analysis
med_fit <- mediate(mediator_model, outcome_model,
                   treat = "Control_Score_log", mediator = "SNAP",
                   boot = TRUE)

# Summary of Mediation Analysis
summary(med_fit)
```


Diagram for model 1
```{r}

library(ggplot2)

# Scatter plot with separate regression lines for SNAP 0 and SNAP 1
ggplot(ECfinal, aes(x = Control_Score_log, y = Picky_Score_log, color = factor(SNAP))) +
  geom_point() +  # Add points
  geom_smooth(method = "lm", se = FALSE, aes(group = factor(SNAP))) +  # Add separate regression lines for each SNAP group
  labs(title = "Control Score vs. Picky Eating by SNAP",
       x = "Control Score (log-transformed)", y = "Picky Eating Score (log-transformed)",
       color = "SNAP Status") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "red"),
                    labels = c("0" = "No SNAP", "1" = "SNAP") )  # Specify colors for SNAP 0 and SNAP 1


```





Check Multicollinearity model 1



```{r}
#Check Multicollinearity model

numeric_predictors <- c("Control_Score_log", "Sex", "Relationship", "Income", "Education", "Relation", "household", "num_children")

# Now run the linear model again
multicollinearity_model <- lm(ECfinal$Picky_Score ~ ., data = ECfinal[numeric_predictors])

# Calculate VIF
vif_values <- vif(multicollinearity_model)
print(vif_values)

```

Mediation

Model 2 and multicllinearity test

```{r}


#model2
mediator_model2 <- glm(SNAP ~ Emotional_Score_log + Sex + Relationship+
                        Income + Education + Relation + household+num_children,
                      family = binomial, data = ECfinal)

outcome_model2 <- lm(Picky_Score_log ~ Emotional_Score_log + SNAP + 
              Sex + Income + Education + Relation + household+ Relationship +num_children ,data = ECfinal)


# Perform the mediation analysis
med_fit2 <- mediate(mediator_model2, outcome_model2, treat = c("Emotional_Score_log"), mediator = "SNAP", boot = TRUE)

# View the summary of mediation analysis
summary(med_fit2)

```

Diagram for model 2

```{r}

# Scatter plot with separate regression lines for SNAP 0 and SNAP 1
ggplot(ECfinal, aes(x = Emotional_Score_log, y = Picky_Score_log, color = factor(SNAP))) +
  geom_point() +  
  geom_smooth(method = "lm", se = FALSE, aes(group = factor(SNAP))) +  # Add separate regression lines for each SNAP group
  labs(title = "Emotional Score vs. Picky Eating by SNAP",
       x = "Emotional Score (log-transformed)", y = "Picky Eating Score (log-transformed)",
       color = "SNAP Status") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "red"),
                     labels = c("0" = "No SNAP", "1" = "SNAP"))  # Specify colors for SNAP 0 and SNAP 1



```
Check Multicollinearity model 2

```{r}

#Check Multicollinearity model

numeric_predictors2 <- c("Emotional_Score_log", "Sex", "Relationship", "Income","num_children", "Education", "Relation", "household")


# Now run the linear model again
multicollinearity_model2 <- lm(ECfinal$Picky_Score ~ ., data = ECfinal[numeric_predictors2])

# Calculate VIF
vif_values2 <- vif(multicollinearity_model2)
print(vif_values2)


```

****************relationship between parental feeding style, child picky eating and BMI

```{r}
#library
 
library("ggplot2")
library("childsds")
library("anthro")
library(car)
library("dplyr")
library(nnet)
```


Read the data and merge the measurments with ECfinal


```{r}
 #read data
cmeasure<- read.csv("C:/Users/sara ghasem pour/GitLab/Path2/Thesis/DataCleaning/cmeasure.csv")


#merged ECfinal with measurment data based on RandomID
Data <- merge(cmeasure, ECfinal, by = "RandomID")


```

BMI Percentile

```{r}
#BMI Percentile

Data$BMIpercentile <- sds(
  value = Data$BMI,
  age = Data$Age,
  sex = Data$sex,
  male = "Male",
  female = "Female",
  ref = cdc.ref,
  item = "bmi",
  type = "perc"
)

```

**** I used 2 ways ,you can see both of them , I am not sure which one is correct , firstly, two categorical BMI percentile ,and  then four Categorical BMI Percentile)

---------------1- two Categorical BMI percentile--------------------------------


Categorizing BMI 

```{r}

Data$BMICat <- ifelse(Data$BMIpercentile > 0.85, 1, 0)
#1= over weigh and obesity
#2.Not
```

Doing GLM for  BMI picky eating and Control feeding
```{r}

# Fit the logistic regression model
glm_model <- glm(BMICat ~ Picky_Score_log + Control_Score_log +
                 Picky_Score_log * Control_Score_log + SNAP + 
                 Sex+ Education + Relation + household + 
                 Relationship + num_children, 
                 family = binomial(link = "logit"), data = Data)

# Summary of the model
summary(glm_model)

```


PLOT for  BMI picky eating and Control feeding
```{r}

# Scatter plot with separate regression lines for BMI
ggplot(Data, aes(x = Control_Score_log, y = Picky_Score_log, color = factor(BMICat))) +
  geom_point() +  
  geom_smooth(method = "lm", se = FALSE, aes(group = factor(BMICat))) +  # Add separate regression lines for each BMICat group
  labs(title = "Control Score vs. Picky Eating by BMI Category",
       x = "Control Score (log-transformed)", y = "Picky Eating Score",
       color = "BMI Category") +
  theme_minimal() +
  scale_color_manual(values = c("0" = "blue", "1" = "red"), 
                     labels = c("0" = "Not Obese/Overweight", "1" = "Obese/Overweight"))  # Specify colors and labels for BMICat 0 and BMICat 1



```

Doing GLM for  BMI picky eating and Emotional feeding
```{r}

# Fit the logistic regression model
glm_model2 <- glm(BMICat ~ Picky_Score_log + Emotional_Score_log +
                 Picky_Score_log * Emotional_Score_log + SNAP + 
                 Sex+ Education + Relation + household + 
                 Relationship + num_children, 
                 family = binomial(link = "logit"), data = Data)

# Summary of the model
summary(glm_model2)

```



PLOT  for  BMI picky eating and Emotional feeding
```{r}

# Scatter plot with separate regression lines for BMI
ggplot(Data, aes(x = Emotional_Score_log, y = Picky_Score_log, color = factor(BMICat))) +
  geom_point() +  
  geom_smooth(method = "lm", se = FALSE, aes(group = factor(BMICat))) +  # Add separate regression lines for each BMICat group
  labs(title = "Emotional Score vs. Picky Eating by BMI Category",
       x = "Emotional Score (log-transformed)", y = "Picky Eating Score",
       color = "BMI Category") +
  theme_minimal() +
  scale_color_manual(values = c("0" = "blue", "1" = "red"), 
                     labels = c("0" = "Not Obese/Overweight", "1" = "Obese/Overweight"))  # Specify colors and labels for BMICat 0 and BMICat 1

```




--------------------.Evaluation based on four Categorical BMI---------------------------

Categorizing BMI 
```{r}
Data <- Data %>%
  mutate(BMI_Category = case_when(
    BMIpercentile < 0.05 ~ "Underweight",
    BMIpercentile >= 0.05 & BMIpercentile <= 0.85 ~ "Normal",
    BMIpercentile > 0.85 & BMIpercentile <= 0.95 ~ "Overweight",
    BMIpercentile > 0.95 ~ "Obese",
    TRUE ~ NA_character_  # for handling any missing or unexpected values
  ))
print(Data$BMI_Category)

```



*********
 PLEASE pay attestation Just Run one of the  following way1 or2  for the first and second model.I don't know which one is correct.
 
 *******
 
FIRST WAY TO FIT THE MODEL 1

Doing Multiple logistic regression for  categorical BMI, control and picky eating:model1
```{r}

# Ensure BMI_Category is a factor
Data$BMI_Category <- as.factor(Data$BMI_Category)

# Fit a multinomial logistic regression model
multinom_model <- multinom(BMI_Category ~ Picky_Score_log + Control_Score_log +
                           Picky_Score_log * Control_Score_log + SNAP + 
                           Sex + Income + Education + Relation + household + 
                           Relationship + num_children, data = Data)

# Summarize the multinomial logistic regression model
summary(multinom_model) 


model_summary <- summary(multinom_model)

# Extract coefficients and standard errors
coefficients <- coef(model_summary)
standard_errors <- model_summary$standard.errors

# Calculate z-values
z_values <- coefficients / standard_errors

# Calculate p-values
p_values <- 2 * (1 - pnorm(abs(z_values)))

print(p_values)


```



SECOND WAY TO FIT THE MODEL 1
GLM for BMI, control and picky eating

```{r}

# Ensure BMI_Category is a factor
Data$BMI_Category <- as.factor(Data$BMI_Category)

# Create binary outcome variables
Data$Obese <- as.numeric(Data$BMI_Category == "Obese")
Data$Overweight <- as.numeric(Data$BMI_Category == "Overweight")
Data$Underweight <- as.numeric(Data$BMI_Category == "Underweight")
Data$Normal <- as.numeric(Data$BMI_Category == "Normal")
# Fit GLM for Obese
glm_obese <- glm(Obese ~ Picky_Score_log + Control_Score_log +
                 Picky_Score_log * Control_Score_log + SNAP + 
                 Sex + Income + Education + Relation + household + 
                 Relationship + num_children, 
                 family = binomial, data = Data)
summary(glm_obese)

# Fit GLM for Overweight
glm_overweight <- glm(Overweight ~ Picky_Score_log + Control_Score_log +
                      Picky_Score_log * Control_Score_log + SNAP + 
                      Sex + Income + Education + Relation + household + 
                      Relationship + num_children, 
                      family = binomial, data = Data)
summary(glm_overweight)

# Fit GLM for Underweight
glm_underweight <- glm(Underweight ~ Picky_Score_log + Control_Score_log +
                       Picky_Score_log * Control_Score_log + SNAP + 
                       Sex + Income + Education + Relation + household + 
                       Relationship + num_children, 
                       family = binomial, data = Data)
summary(glm_underweight)
# Fit GLM for Underweight
glm_Normal <- glm(Normal ~ Picky_Score_log + Control_Score_log +
                       Picky_Score_log * Control_Score_log + SNAP + 
                       Sex + Income + Education + Relation + household + 
                       Relationship + num_children, 
                       family = binomial, data = Data)
summary(glm_Normal)


```


Diagram
```{r}


# Plot with separate regression lines for each level of BMI categories  and one for the overall data
ggplot(Data, aes(x = Control_Score_log, y = Picky_Score_log)) +
  geom_point(aes(color = BMI_Category)) + 
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, linetype = "dotted", color = "black") +  # Overall regression line
  geom_smooth(data = Data %>% filter(BMI_Category== "Obese"), method = "lm", formula = y ~ x, se = FALSE, color = "blue") +
    geom_smooth(data = Data %>% filter(BMI_Category== "Underweight"), method = "lm", formula = y ~ x, se = FALSE, color = "yellow") +
  geom_smooth(data = Data %>% filter(BMI_Category == "Overweight"), method = "lm", formula = y ~ x, se = FALSE, color = "green") +
  geom_smooth(data = Data %>% filter(BMI_Category == "Normal"), method = "lm", formula = y~ x, se = FALSE, color = "red") +
  labs(title = "Control Score vs.Picky Eating Categories  Across BMI Category",
       x = "Control Score (log-transformed)", 
       y = "Picky Eating Category",
       color = "BMI category") +
  theme_minimal() +
  scale_color_manual(values = c("Obese" = "blue", "Underweight" = "yellow", "Overweight" = "green", "Normal" = "red"))
 
```





Test Multicollinearity for model 1

```{r}
# Calculate the correlation matrix of predictors
correlation_matrix <- cor(Data[c("Picky_Score_log", "Control_Score_log", "SNAP", "Sex", "Income", "Education", "Relation", "household", "Relationship", "num_children")])

# View the correlation matrix
print(correlation_matrix)


```

FIRST WAY TO FIT THE MODEL 2

Doing Multiple logistic regression for  categorical BMI, Emotional and picky eating
```{r}

# Ensure BMI_Category is a factor
Data$BMI_Category <- as.factor(Data$BMI_Category)

# Fit a multinomial logistic regression model
multinom_model2 <- multinom(BMI_Category ~ Picky_Score_log + Emotional_Score_log +
                           Picky_Score_log * Emotional_Score_log + SNAP + 
                           Sex + Income + Education + Relation + household + 
                           Relationship + num_children, data = Data)

# Summarize the multinomial logistic regression model
summary(multinom_model2) 


model_summary2 <- summary(multinom_model2)

# Extract coefficients and standard errors
coefficients2 <- coef(model_summary2)
standard_errors2 <- model_summary$standard.errors2

# Calculate z-values
z_values2 <- coefficients2 / standard_errors2

# Calculate p-values
p_values2 <- 2 * (1 - pnorm(abs(z_values2)))

print(p_values2)


```




SECOND WAY TO FIT THE MODEL 2
GLM for BMI, Emotional and picky eating

```{r}

# Ensure BMI_Category is a factor
Data$BMI_Category <- as.factor(Data$BMI_Category)

# Create binary outcome variables
Data$Obese <- as.numeric(Data$BMI_Category == "Obese")
Data$Overweight <- as.numeric(Data$BMI_Category == "Overweight")
Data$Underweight <- as.numeric(Data$BMI_Category == "Underweight")
Data$Normal <- as.numeric(Data$BMI_Category == "Normal")
# Fit GLM for Obese
glm_obese2 <- glm(Obese ~ Picky_Score_log + Emotional_Score_log +
                 Picky_Score_log * Control_Score_log + SNAP + 
                 Sex + Income + Education + Relation + household + 
                 Relationship + num_children, 
                 family = binomial, data = Data)
summary(glm_obese2)

# Fit GLM for Overweight
glm_overweight2 <- glm(Overweight ~ Picky_Score_log + Emotional_Score_log +
                      Picky_Score_log * Control_Score_log + SNAP + 
                      Sex + Income + Education + Relation + household + 
                      Relationship + num_children, 
                      family = binomial, data = Data)
summary(glm_overweight2)

# Fit GLM for Underweight
glm_underweight2 <- glm(Underweight ~ Picky_Score_log + Emotional_Score_log +
                       Picky_Score_log * Control_Score_log + SNAP + 
                       Sex + Income + Education + Relation + household + 
                       Relationship + num_children, 
                       family = binomial, data = Data)
summary(glm_underweight2)
# Fit GLM for Underweight
glm_Normal2 <- glm(Normal ~ Picky_Score_log + Emotional_Score_log +
                       Picky_Score_log * Control_Score_log + SNAP + 
                       Sex + Income + Education + Relation + household + 
                       Relationship + num_children, 
                       family = binomial, data = Data)
summary(glm_Normal2)


```


Diagram for model 2, 


```{r}


# Plot with separate regression lines for each level of BMI categories  and one for the overall data
ggplot(Data, aes(x = Emotional_Score_log, y = Picky_Score_log)) +
  geom_point(aes(color = BMI_Category)) + 
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, linetype = "dotted", color = "black") +  # Overall regression line
  geom_smooth(data = Data %>% filter(BMI_Category== "Obese"), method = "lm", formula = y ~ x, se = FALSE, color = "blue") +
    geom_smooth(data = Data %>% filter(BMI_Category== "Underweight"), method = "lm", formula = y ~ x, se = FALSE, color = "yellow") +
  geom_smooth(data = Data %>% filter(BMI_Category == "Overweight"), method = "lm", formula = y ~ x, se = FALSE, color = "green") +
  geom_smooth(data = Data %>% filter(BMI_Category == "Normal"), method = "lm", formula = y~ x, se = FALSE, color = "red") +
  labs(title = "Emotional Score vs.Picky Eating Categories  Across BMI Category",
       x = "Emotional Score (log-transformed)", 
       y = "Picky Eating Category",
       color = "BMI category") +
  theme_minimal() +
  scale_color_manual(values = c("Obese" = "blue", "Underweight" = "yellow", "Overweight" = "green", "Normal" = "red"))
 
```

Test Multicollinearity for model 2

```{r}
# Calculate the correlation matrix of predictors
correlation_matrix <- cor(Data[c("Picky_Score_log", "Emotional_Score_log", "SNAP", "Sex", "Income", "Education", "Relation", "household", "Relationship", "num_children")])

# View the correlation matrix
print(correlation_matrix)

```






