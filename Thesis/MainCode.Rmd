---
title: "Rmaincode"
output: html_document
date: "2023-12-18"
---

```{r}

#Library
library(dplyr)
rm(list = ls())
cat("\014")  # Clears the console



library(dplyr)
library(ggplot2)
library(mediation)
library(car)


```


```{r}
#Read the data

ECfinal<- read.csv("C:/Users/sara ghasem pour/GitLab/Path2/Thesis/DataCleaning/ECfinal.csv")

```

SNAP
```{r}
# Create a new binary column 'SNAP_Selected' based on the presence of "SNAP" in 'CNP4'
ECfinal$SNAP <- ifelse(grepl("SNAP", ECfinal$CNP4, fixed = TRUE), 1, 0)


```


Picky eating- Parent control- Parent emotional

```{r}
# Define the mapping from text responses to numeric values
EClist <- c("Always" = 5, "Often" = 4, "Sometimes" =3 , "Rarely" = 2, "Never" = 1 )

# List the question columns for each category based on the names you provided
control_questions <- c("PFSQ5", "PFSQ17", "PFSQ18", "PFSQ20", "PFSQ24", "PFSQ26")
emotional_questions <- c("PFSQ25", "PFSQ21", "PFSQ22", "PFSQ15", "PFSQ13", "PFSQ2")
picky_questions <- c("CEBQ32", "CEBQ24", "CEBQ16", "CEBQ10", "CEBQ7")

# Convert text responses to numeric values and calculate mean scores for control, emotional eating, and picky eating
ECfinal <- ECfinal %>%
  mutate(
    across(all_of(control_questions), ~ as.numeric(EClist[.x]), .names = "numeric_{.col}"),
    across(all_of(emotional_questions), ~ as.numeric(EClist[.x]), .names = "numeric_{.col}"),
    across(all_of(picky_questions), ~ as.numeric(EClist[.x]), .names = "numeric_{.col}")
  ) %>%
  rowwise() %>%
  mutate(
    Control_Score = mean(c_across(starts_with("numeric_PFSQ")), na.rm = TRUE),
    Emotional_Score = mean(c_across(starts_with("numeric_PFSQ")), na.rm = TRUE),
    Picky_Score = mean(c_across(starts_with("numeric_CEBQ")), na.rm = TRUE)
  ) %>%
  ungroup()


```

Checked the normality  


 
 
 
```{r}
#shapiro test normality for main variables
variables_to_test <- c("Picky_Score", "Control_Score", "Emotional_Score")
print(variables_to_test)
# Apply the Shapiro-Wilk test to each variable
normality_tests <- lapply(ECfinal[variables_to_test], shapiro.test)
# Print the results
print(normality_tests)
```


```{r}
#QQplot

variables_to_test <- c("Picky_Score", "Control_Score", "Emotional_Score")

for (variable in variables_to_test) {
  # Create a QQ plot for each variable
  p <- ggplot(ECfinal, aes(sample = .data[[variable]])) +
       stat_qq() +
       stat_qq_line(colour = "blue") +
       ggtitle(paste("QQ Plot for", variable)) +
       theme_minimal()
  
  # Print the plot
  print(p)
}
```





```{r}
# Log transformation 

ECfinal$Control_Score_log <- log(ECfinal$Control_Score + 1e-6)
ECfinal$Emotional_Score_log <- log(ECfinal$Emotional_Score + 1e-6)
```



```{r}

#QQplot log

variables_log <- c( "Control_Score_log", "Emotional_Score_log")


for (variable in variables_log) {
  # Create a QQ plot for each variable
  p <- ggplot(ECfinal, aes(sample = .data[[variable]])) +
       stat_qq() +
       stat_qq_line(colour = "blue") +
       ggtitle(paste("QQ Plot for", variable)) +
       theme_minimal()
  
  # Print the plot
  print(p)
}
```


```{r}
# Shapiro-Wilk test for log-transformed variables
shapiro_results_log <- lapply(ECfinal[variables_log], shapiro.test)

# Print the Shapiro-Wilk test results
print(shapiro_results_log)
```

 picky _Score has  not normal distributed, I did :
 Log Transformation
 Square Root Transformation
 Inverse Transformation
 Box-Cox Transformation
 Yeo-Johnson Transformation
 So I change Picky eating to categorical Data, LOW, MED, HIGH
```{r}
# Categorize Picky_Score into three categories: Low, Medium, High
ECfinal <- ECfinal %>%
  mutate(
    Picky_Category = cut(Picky_Score,
                         breaks = quantile(Picky_Score, probs = c(0, 0.33, 0.66, 1), na.rm = TRUE),
                         labels = c("Low", "Medium", "High"),
                         include.lowest = TRUE)
  )

```

Household
```{r}

ECfinal$household <- as.numeric(as.character(ECfinal$household))

```

childs number
```{r}

ECfinal$num_children <- as.numeric(as.character(ECfinal$num_children))

```

Relationship

```{r}
relationship_map <- c("Never married" = 5, 
                      "Married" = 1, 
                      "Divorced" = 2, 
                      "Separated" = 3, 
                      "Widowed" = 4)

# Convert text responses to numeric values for Relationship status
ECfinal <- ECfinal %>%
  mutate(Relationship = relationship_map[relationship])


```

Race Ethnicity

```{r}
# Create a data frame with the race data
race_data <- data.frame(
  race_category = c("White", "Vietnamese", "Other Asian", "Native Hawaiian", 
                    "Japanese", "Chinese", "Black or African American", 
                    "Asian Indian", "Another race", 
                    "American Indian or Alaska Native", "Indonesian", "Bengali", "Asian"),
  value = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3),
  detailed_description = c(NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "Indonesian", "Bengali", "Asian")
)
# Convert race_category to a factor with levels ordered by the value column
race_data$race_numeric <- as.numeric(factor(race_data$race_category, 
                                            levels = unique(race_data$race_category[order(race_data$value)])))


```


Parent Education
```{r}
# Define the mapping from education levels to numeric values
education_map <- c("Some high school" = 1, 
                   "High school degree or GED" = 2, 
                   "Some college or associates degree" = 3, 
                   "4 years college degree" = 4, 
                   "Advanced degree" = 5)

# Convert text responses to numeric values for Education
ECfinal <- ECfinal %>%
  mutate(Education = education_map[ed])

```

Household Income
```{r}
income_map <- c("Less than $20,000" = 1, 
                "$20,000 - $39,999" = 2, 
                "$40,000 - $49,999" = 3, 
                "$50,000 - $74,999" = 4, 
                "$75,000 - $99,999" = 5, 
                "More than $100,000" = 6)
#Convert text responses to numeric values and calculate mean scores for Income
ECfinal <- ECfinal %>%
  mutate(Income = income_map[income])

```

Parent
```{r}

# Define the mapping from childs_ parents relationship levels to numeric values
relation_map <- c("Father" = 1, "Mother" = 2, "Other" = 3)

# Assuming 'com2' is your data frame and 'relation' is the column with these responses
ECfinal <- ECfinal %>%
  mutate(Relation = relation_map[parent])




```

Child_sex
```{r}


# Define the mapping from sex categories to numeric values (only male and female)
sex_map <- c("Male" = 1, "Female" = 2)

# Assuming 'com2' is your data frame and 'sex' is the column with these responses
ECfinal <- ECfinal %>%
  mutate(Sex = sex_map[sex])


```

Mediation

Model 1 and multicllinearity test
```{r}

# Mediation analysis with interactions
mediator_model <- glm(SNAP ~ Control_Score_log + Sex + Relationship+
                        Income + Education + Relation + household + num_children,
                      family = binomial, data = ECfinal)

# Step 2: Outcome Model
outcome_model <- glm(Picky_Category ~ Control_Score_log + SNAP +
                      Sex + Income + Education + Relation + household + Relationship + num_children ,family = binomial, data = ECfinal)

# Step 3: Perform Mediation Analysis
med_fit <- mediate(mediator_model, outcome_model,
                   treat = "Control_Score_log", mediator = "SNAP",
                   boot = TRUE)

# Summary of Mediation Analysis
summary(med_fit)
```


Diagram for model 1
```{r}

library(ggplot2)

# Scatter plot with separate regression lines for SNAP 0 and SNAP 1
ggplot(ECfinal, aes(x = Control_Score_log, y = Picky_Score, color = factor(SNAP))) +
  geom_point() +  # Add points
  geom_smooth(method = "lm", se = FALSE, aes(group = factor(SNAP))) +  # Add separate regression lines for each SNAP group
  labs(title = "Control Score vs. Picky Eating by SNAP",
       x = "Control Score (log-transformed)", y = "Picky Eating Score (log-transformed)",
       color = "SNAP Status") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "red"),
                    labels = c("0" = "No SNAP", "1" = "SNAP") )  # Specify colors for SNAP 0 and SNAP 1


```





Check Multicollinearity model 1



```{r}
#Check Multicollinearity model

numeric_predictors <- c("Control_Score_log", "Sex", "Relationship", "Income", "Education", "Relation", "household", "num_children")

# Now run the linear model again
multicollinearity_model <- lm(ECfinal$Picky_Score ~ ., data = ECfinal[numeric_predictors])

# Calculate VIF
vif_values <- vif(multicollinearity_model)
print(vif_values)

```

Mediation

Model 2 and multicllinearity test

```{r}


#model2
mediator_model2 <- glm(SNAP ~ Emotional_Score_log + Sex + Relationship+
                        Income + Education + Relation + household+num_children,
                      family = binomial, data = ECfinal)

outcome_model2 <- glm(Picky_Category ~ Emotional_Score_log + SNAP + 
              Sex + Income + Education + Relation + household+ Relationship +num_children ,family = binomial, data = ECfinal)


# Perform the mediation analysis
med_fit2 <- mediate(mediator_model2, outcome_model2, treat = c("Emotional_Score_log"), mediator = "SNAP", boot = TRUE)

# View the summary of mediation analysis
summary(med_fit2)

```

Diagram for model 2

```{r}

# Scatter plot with separate regression lines for SNAP 0 and SNAP 1
ggplot(ECfinal, aes(x = Emotional_Score_log, y = Picky_Score, color = factor(SNAP))) +
  geom_point() +  
  geom_smooth(method = "lm", se = FALSE, aes(group = factor(SNAP))) +  # Add separate regression lines for each SNAP group
  labs(title = "Emotional Score vs. Picky Eating by SNAP",
       x = "Emotional Score (log-transformed)", y = "Picky Eating Score (log-transformed)",
       color = "SNAP Status") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "red"),
                     labels = c("0" = "No SNAP", "1" = "SNAP"))  # Specify colors for SNAP 0 and SNAP 1



```
Check Multicollinearity model 2

```{r}

#Check Multicollinearity model

numeric_predictors2 <- c("Emotional_Score_log", "Sex", "Relationship", "Income","num_children", "Education", "Relation", "household")


# Now run the linear model again
multicollinearity_model2 <- lm(ECfinal$Picky_Score ~ ., data = ECfinal[numeric_predictors2])

# Calculate VIF
vif_values2 <- vif(multicollinearity_model2)
print(vif_values2)

```

****************relationship between parental feeding style, child picky eating and BMI

```{r}
#library
 
library("ggplot2")
library("childsds")
library("anthro")
library(car)
library("dplyr")
library(nnet)
```


Read the data and merge the measurments with ECfinal


```{r}
 #read data
cmeasure<- read.csv("C:/Users/sara ghasem pour/GitLab/Path2/Thesis/DataCleaning/cmeasure.csv")


#merged ECfinal with measurment data based on RandomID
Data <- merge(cmeasure, ECfinal, by = "RandomID")


```

BMI Percentile

```{r}
#BMI Percentile

Data$BMIpercentile <- sds(
  value = Data$BMI,
  age = Data$Age,
  sex = Data$sex,
  male = "Male",
  female = "Female",
  ref = cdc.ref,
  item = "bmi",
  type = "perc"
)

```

Normalize BMI Percentile
```{r}
# Apply the arcsine transformation for normality
Data$BMIp <- asin(sqrt(Data$BMIpercentile))
tBMI_arcsine <- shapiro.test(Data$BMIp)
print(tBMI_arcsine)
```
Linear regression for model 1: the relationship between interaction of Picky eating and Control feeding on Child BMI
```{r}

 lm <- lm(BMIp~ Picky_Category + Control_Score_log + 
                Picky_Category* Control_Score_log + SNAP + 
              Sex + Income + Education + Relation + household+ Relationship +num_children, data = Data)
summary(lm)

```

Diagram model 1

```{r}

# Plot BMI vs. Emotional Score with categorized Picky Eating Score and separate strict regression lines
ggplot(Data, aes(x = Control_Score_log, y = BMIp, color = Picky_Category)) +
  geom_point() + 
  geom_smooth(aes(group = Picky_Category, color = Picky_Category), 
              method = "lm", formula = y ~ x, se = FALSE, linetype = "solid") +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, linetype = "solid", color = "black") + # Overall regression line
  labs(title = "BMI vs. Control Score",
       x = "Control Score (log-transformed)", 
       y = "BMI",
       color = "Picky Eating Category") +
  scale_color_manual(values = c("Low" = "blue", "Medium" = "green", "High" = "red"),
                     name = "Picky Eating Category") +
  annotate("text", x = max(Data$Control_Score_log), y = min(Data$BMI), 
           label = "Overall Effect of Picky Eating", hjust = 1, vjust = 0) +
  theme_minimal()


```

 correlation matrix of predictors for model 1

```{r}
 
# Calculate the correlation matrix of predictors
 correlation_matrix <- cor(Data[c("Picky_Score", "Control_Score_log", "SNAP", "Sex", "Income", "Education", "Relation", "household", "Relationship", "num_children")])
 
 # View the correlation matrix
print(correlation_matrix)

```
Linear regression for model relationship between BMI and interaction of Emotional eating and Picky eating: model 2
```{r}

 lm2 <- lm(BMIp~ Picky_Category + Emotional_Score_log + 
                Picky_Category * Emotional_Score_log + SNAP + 
              Sex + Income + Education + Relation + household+ Relationship +num_children, data = Data)
summary(lm2)

```

Diagram model 2

```{r}

# Plot BMI vs. Emotional Score with categorized Picky Eating Score and separate strict regression lines
ggplot(Data, aes(x = Emotional_Score_log, y = BMIp, color = Picky_Category)) +
  geom_point() + 
  geom_smooth(aes(group = Picky_Category, color = Picky_Category), 
              method = "lm", formula = y ~ x, se = FALSE, linetype = "solid") +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, linetype = "solid", color = "black") + # Overall regression line
  labs(title = "BMI vs. Emotional Score",
       x = "Emotional Score (log-transformed)", 
       y = "BMI",
       color = "Picky Eating Category") +
  scale_color_manual(values = c("Low" = "blue", "Medium" = "green", "High" = "red"),
                     name = "Picky Eating Category") +
  annotate("text", x = max(Data$Emotional_Score_log), y = min(Data$BMI), 
           label = "Overall Effect of Picky Eating", hjust = 1, vjust = 0) +
  theme_minimal()


```

correlation matrix of predictors for model 2

```{r}
 
# Calculate the correlation matrix of predictors
 correlation_matrix <- cor(Data[c("Picky_Score", "Emotional_Score_log", "SNAP", "Sex", "Income", "Education", "Relation", "household", "Relationship", "num_children")])
 
 # View the correlation matrix
print(correlation_matrix)

```





